<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive ISBN Visualization</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: white;
            padding: 20px;
        }

        .content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .canvas-container {
            position: relative;
            margin: 20px auto;
            width: 1000px;
            height: 800px;
            border: 1px solid #444;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #globalViewCanvas {
            z-index: 1;
        }

        #overlayCanvas {
            background-color: transparent;
            z-index: 2;
            pointer-events: none; /* Prevent the overlay from blocking interactions */
        }
        #newOverlayCanvas {
            z-index: 3;
            pointer-events: none; /* Prevent the overlay from blocking interactions */
            display: none;
        }

        .toolbar {  /*make the tool bar plain and simple*/
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .toolbar .collection-item {
            /* font being bold */
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: #2e2e2e;
            transition: background-color 0.3s;
        }

        .toolbar .collection-item.all {
            color : black; 
            background-color: #cccccc;
        }

        .toolbar .collection-item:hover {
            background-color: green;
        }
        .toolbar .collection-item.all:hover {
            background-color: #eeeeee;
        }

        footer {
            margin-top: 40px;
            font-size: 0.9em;
            color: #aaa;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            pointer-events: none;
            font-size: 12px;
            display: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1>Welcome to the ISBN Universe</h1>
        <p>
            This project offers an interactive visualization of the entire ISBN universe. Each pixel on the canvas
            represents a range of ISBNs, providing a comprehensive view of global book metadata collections.
        </p>
        <p>
            Hover over the collection options to explore how different datasets contribute to the ISBN universe.
            Our visualization demonstrates the scope of book metadata across sources such as Anna's Archive, Google Books, and more.
        </p><hr/>
        <span class="toolbar">
            <span class="collection-item all" data-collection="all">All (background)</span>
            <span class="collection-item" data-collection="md5">Anna's Archive</span>
            <span class="collection-item" data-collection="cadal_ssno">CADAL</span>
            <span class="collection-item" data-collection="cerlalc">CERLALC</span>
            <span class="collection-item" data-collection="duxiu_ssid">DuXiu</span>
            <span class="collection-item" data-collection="edsebk">EBSCOhost</span>            
            <span class="collection-item" data-collection="gbooks">Google Books</span>
            <span class="collection-item" data-collection="goodreads">Goodreads</span>
            <span class="collection-item" data-collection="ia">Internet Archive</span>
            <span class="collection-item" data-collection="isbngrp">ISBN Global Register</span>
            <span class="collection-item" data-collection="libby">Libby</span>
            <span class="collection-item" data-collection="nexusstc">Nexus/STC</span>
            <span class="collection-item" data-collection="oclc">OCLC/Worldcat</span>
            <span class="collection-item" data-collection="ol">OpenLibrary</span>
            <span class="collection-item" data-collection="rgb">Russian State Library</span>
            <span class="collection-item" data-collection="trantor">Imperial Library of Trantor</span>
            
        </span>
        <div class="canvas-container">
            <canvas id="globalViewCanvas" width="1000" height="800"></canvas>
            <canvas id="overlayCanvas" width="1000" height="800"></canvas>
            <!-- <canvas id="newOverlayCanvas" width="1000" height="800"></canvas> -->
        </div>
        <p>
            As you explore, you'll notice the interplay between different datasets. The light green pixels represent
            the base dataset, and hovering over additional collections will overlay their unique contributions in varying colors.
        </p>
    </div>
    <footer>
        Â© 2025 ISBN Visualization Project. All rights reserved.
    </footer>
    <script>
        const TILE_RATIO = 50; // Global canvas divided into 50x50 tiles
        const CUE_WIDTH = 20;  // Width of rectangle cue
        const CUE_HEIGHT = 16; // Height of rectangle cue

        const globalCanvas = document.getElementById("globalViewCanvas");
        const globalCtx = globalCanvas.getContext("2d");
        const overlayCanvas = document.getElementById("overlayCanvas");
        const overlayCtx = overlayCanvas.getContext("2d");
        // const newOverlayCanvas = document.getElementById("newOverlayCanvas");
        // const newOverlayCtx = newOverlayCanvas.getContext("2d");
        const tooltip = document.createElement("div");
    
        // Tooltip styling
        tooltip.className = "tooltip"; 
        document.body.appendChild(tooltip);
    
        // Load base layer
        const baseLayer = new Image();
        baseLayer.src = "/static/globals/all_isbns_smaller.png";
        baseLayer.onload = () => {
            globalCtx.drawImage(baseLayer, 0, 0, globalCanvas.width, globalCanvas.height);
        };

        
   
        // Function to overlay non-black parts
        function loadOverlay(collection) {
            const overlayImage = new Image();
            overlayImage.src = `/static/globals/${collection}_isbns_smaller.png`;
    
            overlayImage.onload = () => {
                overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    
                const offscreenCanvas = document.createElement("canvas");
                const offscreenCtx = offscreenCanvas.getContext("2d");
                offscreenCanvas.width = overlayImage.width;
                offscreenCanvas.height = overlayImage.height;
    
                offscreenCtx.drawImage(overlayImage, 0, 0);
    
                const imageData = offscreenCtx.getImageData(0, 0, overlayImage.width, overlayImage.height);
                const data = imageData.data;
    
                for (let y = 0; y < overlayCanvas.height; y++) {
                    for (let x = 0; x < overlayCanvas.width; x++) {
                        const index = (y * overlayImage.width + x) * 4;
    
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
    
                        if (r !== 0 || g !== 0 || b !== 0) {
                            overlayCtx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.7)`;
                            overlayCtx.fillRect(x, y, 1, 1);
                        }
                    }
                }
            };
        }
        // Add hover listeners for overlays
        document.querySelectorAll(".collection-item").forEach(item => {
            item.addEventListener("mouseover", (event) => {
                const collection = event.target.dataset.collection;
                loadOverlay(collection);
            });
    
            item.addEventListener("mouseleave", () => {
                overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            });
        });
        
        globalCanvas.addEventListener("mousemove", (event) => {
            const rect = globalCanvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;

            const cellWidth = globalCanvas.width / 1000; // Assuming 1000x800 grid
            const cellHeight = globalCanvas.height / 800;

            const col = Math.floor(mouseX / cellWidth);
            const row = Math.floor(mouseY / cellHeight);

            const startX = col * cellWidth;
            const startY = row * cellHeight;

            const tileX = Math.floor(mouseX / CUE_WIDTH);
            const tileY = Math.floor(mouseY / CUE_HEIGHT);

            // Clear previous cue
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

            // Draw rectangle cue
            overlayCtx.strokeStyle = "red";
            overlayCtx.lineWidth = 2;
            overlayCtx.strokeRect(tileX * CUE_WIDTH, tileY * CUE_HEIGHT, CUE_WIDTH, CUE_HEIGHT);

            // Tooltip for ISBN range
            const baseIsbnStart = (row * 1000 + col) * 2500 + 978000000000;
            const baseIsbnEnd = baseIsbnStart + 2499;

            tooltip.innerText = `Tile: ${tileX} - ${tileY}`;
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY + 10}px`;
            tooltip.style.display = "block";
        });

        // Hide tooltip and highlight when leaving the canvas
        globalCanvas.addEventListener("mouseleave", () => {
            tooltip.style.display = "none";
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        });


        globalCanvas.addEventListener("dblclick", (event) => {
            const rect = globalCanvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;

            const tileX = Math.floor(mouseX / 50);
            const tileY = Math.floor(mouseY / 50);
            
            renderTileView(tileX, tileY);
        });



        async function renderTileView(tileX, tileY) {

            const clusterId = `${tileX}_${tileY}`;
            //construct the .png file path
            const response = await fetch(`/static/tiles/tile_${clusterId}.png`);
            const blob = await response.blob();
            const img = new Image();
            img.src = URL.createObjectURL(blob);

            // 
            img.onload = ()  => animateZoomIn(img, tileX, tileY);

        }

        function animateZoomIn(img, tileX, tileY) {
            let scale = 0.1; // Start with a small scale
            const startX = tileX * 50;
            const startY = tileY * 50;

            const interval = setInterval(() => {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            overlayCtx.save();
            overlayCtx.translate(startX, startY);
            overlayCtx.scale(scale, scale);
            overlayCtx.translate(-startX, -startY);
            overlayCtx.drawImage(img, 0, 0, globalCanvas.width, globalCanvas.height);
            overlayCtx.restore();

            scale += 0.05; // Increment scale
            if (scale >= 1) {
                clearInterval(interval);
                renderClusterView(img); // Replace global canvas with cluster view
            }
            }, 16); // 60 FPS animation
        }

        function renderClusterView(img) {
            overlayCtx.clearRect(0, 0, globalCanvas.width, globalCanvas.height);
            overlayCtx.drawImage(img, 0, 0, globalCanvas.width, globalCanvas.height);
        }

    </script>
    
</body>
</html>
