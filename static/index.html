<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISBN Global View</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 1px solid #ccc;
            display: block;
            margin: 20px auto;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            pointer-events: none;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>ISBN Global View</h1>
    <canvas id="visualization" width="800" height="1000"></canvas>
    <div class="tooltip" id="tooltip"></div>

    <script>
        const canvas = document.getElementById("visualization");
        const ctx = canvas.getContext("2d");
        const tooltip = document.getElementById("tooltip");

        let cellWidth, cellHeight, gridData;



        fetch('/api/global_view')
            .then(response => response.json())
            .then(data => {
                gridData = data;

                // Calculate cell dimensions
                cellWidth = canvas.width / gridData[0].length;
                cellHeight = canvas.height / gridData.length;

                // Render the grid
                drawGrid();

                // Add mousemove event for tooltip
                canvas.addEventListener("mousemove", (event) => {
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = event.clientX - rect.left;
                    const mouseY = event.clientY - rect.top;

                    // Calculate grid cell
                    const col = Math.floor(mouseX / cellWidth);
                    const row = Math.floor(mouseY / cellHeight);

                    if (gridData[row] && gridData[row][col]) {

                        const color = gridData[row][col];
                        const colorString = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                        
                        // Calculate ISBN range for the cell
                        const rangeStart = (row * gridData[0].length + col) * 2500 + 978000000000;
                        const rangeEnd = rangeStart + 2500 - 1;

                        // Update tooltip content and position
                        tooltip.innerText = `2500 ISBNs: \n-------\n${rangeStart}x \n    ~   \n${rangeEnd}x`;
                        tooltip.style.left = `${event.clientX + 10}px`;
                        tooltip.style.top = `${event.clientY + 10}px`;
                        tooltip.style.backgroundColor = colorString; // Set tooltip background color
                        tooltip.style.color = getTextColor(color); // Adjust text color for contrast
                        tooltip.style.display = "block";
                    } else {
                        tooltip.style.display = "none";
                    }
                });

                // Hide tooltip when mouse leaves canvas
                canvas.addEventListener("mouseleave", () => {
                    tooltip.style.display = "none";
                });
            });

        function drawGrid() {
            gridData.forEach((row, y) => {
                row.forEach((color, x) => {
                    ctx.fillStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                    ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                });
            });
        }

        //helper
        function getTextColor(rgb) {
            // Calculate brightness using the luminance formula
            const brightness = 0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2];
            return brightness > 128 ? "black" : "white"; // Use black for bright backgrounds, white for dark
        }

    </script>
</body>
</html>
